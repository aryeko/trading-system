# S-04: Strategy Engine (Signals + Ranking)

**Last updated:** 2025-09-21

## Outcome
- Evaluate strategy entry/exit conditions at the close and compute rank metrics for universe selection, producing machine-readable signals.
- Provide deterministic signal outputs given curated inputs and strategy configuration.

## Deliverables
- `trading_system.signals` module with a `StrategyEngine` class (or equivalent functions) accepting curated data and strategy config to produce `signals.parquet`.
- Support for rule-based entries/exits (e.g., `close > sma_100`) and configurable rank metric (default: 63-day momentum, extensible via plug-ins).
- CLI command `ts signals build --config configs/sample-config.yml --asof 2024-05-02 [--window 252]` generating signals for the requested date.

## Functional Requirements
- Signals must include columns: `date`, `symbol`, `signal` (`BUY`/`HOLD`/`EXIT`), `rank_score`, and any feature columns needed by rebalancing.
- Engine reads curated parquet files from `paths.data_curated/<asof>` and optionally previous days for lookback metrics.
- Deterministic tie-breaking: when rank scores tie, higher alphabetical symbol wins.
- Support dry-run evaluation (no file writes) for investigation.
- Log rule evaluations for debugging (e.g., number of symbols passing entry rule).

## CLI Additions
- `poetry run ts signals build --config <path> --asof YYYY-MM-DD` writes `signals.parquet` under `reports/<asof>/signals.parquet` or configured output directory.
- `poetry run ts signals explain --config <path> --symbol AAPL --asof YYYY-MM-DD` prints contributing indicators and rule outcomes for the symbol.

## Verification
1. Prepare curated data (from S-03) and run `poetry run ts signals build --config <config> --asof 2024-05-02`.
2. Inspect the resulting `signals.parquet`: confirm required columns, correct dtypes, and deterministic ordering.
3. Use `ts signals explain` for a known crossover scenario and confirm narrative matches expected rule evaluation.
4. Run `pytest` for strategy-related tests covering entry/exit logic, ranking tie-breakers, and determinism.

## Dependencies
- S-01, S-03.

## Notes
- Keep the rule DSL declarative to allow future extension (e.g., additional indicators) without rewriting the engine.
