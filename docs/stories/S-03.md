# S-03: Preprocessing Pipeline

**Last updated:** 2025-09-21

## Outcome
- Transform raw parquet bars into curated datasets aligned to the trading calendar with core indicators derived upfront.
- Enforce the curated schema described in `TECH_DESIGN_REQUIREMENTS.md` and make preprocessing deterministic across runs.

## Deliverables
- `trading_system.preprocess.Preprocessor` class capable of reading `/data/raw/<asof>/*.parquet`, applying adjustments, filling gaps within policy, and emitting `/data/curated/<asof>/<symbol>.parquet`.
- Config-driven preprocessing policy (`PreprocessConfig`) controlling forward-fill tolerance, rolling peak window, calendar frequency, and adjustment behavior.
- CLI command `ts data preprocess --config configs/sample-config.yml --asof 2024-05-02 [--force]` that runs preprocessing for a given date.

## Functional Requirements
- Validate input frames using `ensure_bars_frame`; raise explicit errors when required columns are missing.
- Align each symbol to the configured calendar frequency, forward-fill gaps up to `forward_fill_limit`, and log warnings for any residual NaNs beyond the limit.
- Apply split/dividend adjustments by default when both `close` and `adj_close` are present; leave prices untouched when adjustments are disabled in config.
- Derive at minimum: `sma_100`, `sma_200`, `ret_1d`, `ret_20d`, and `rolling_peak` (window configurable via policy).
- Write curated parquet files with the canonical column order and without indices; ensure output is idempotent when raw data is unchanged.

## CLI Additions
- `poetry run ts data preprocess --config <path> --asof YYYY-MM-DD` executes preprocessing and prints a summary table (symbols processed, warnings emitted).
- `poetry run ts data preprocess --config <path> --asof YYYY-MM-DD --dry-run` validates inputs and reports planned work without writing files.

## Verification
1. After running `ts data pull`, execute `poetry run ts data preprocess --config <config> --asof 2024-05-02`.
2. Confirm output directory `data/curated/2024-05-02` exists and contains parquet files for every symbol returned by the pull step.
3. Load a curated file and validate indicator columns against expected formulas (rolling averages, returns, peak).
4. Run the command twice and verify no changes occur on the second run (timestamps, file hashes remain the same).
5. Execute `pytest tests/test_preprocessor.py` to cover edge cases (missing data gaps, adjustment toggles).

## Dependencies
- S-01, S-02.

## Notes
- The curated schema is a contract for signal, risk, and rebalance engines; changes require coordinated updates and golden fixtures.
