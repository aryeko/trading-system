# S-06: Rebalancer (Portfolio Construction)

**Last updated:** 2025-09-21

## Outcome
- Convert strategy signals and holdings into a concrete rebalance proposal with target weights and suggested orders, honoring turnover, cash buffer, and minimum weight constraints.
- Produce artifacts that downstream reporting and operators can execute manually.

## Deliverables
- `trading_system.rebalance` module implementing a `RebalanceEngine` that consumes signals, holdings, and rebalance config to generate `rebalance_proposal.json`.
- Order construction logic producing side (`BUY`/`SELL`), quantity, and notional hints based on latest prices.
- CLI command `ts rebalance propose --config configs/sample-config.yml --holdings data/holdings.json --signals reports/2024-05-02/signals.parquet --asof 2024-05-02`.

## Functional Requirements
- Enforce cadence: only produce a proposal when the current date matches the configured rebalance frequency; otherwise emit a `NO_REBALANCE` summary.
- Respect `max_positions`, `min_weight`, `equal_weight`, `cash_buffer`, and `turnover_cap_pct` from config.
- Drop positions that violate exit rules; include rationale per symbol in output.
- Output JSON includes `targets`, `orders`, `cash_buffer`, `turnover`, and `notes` explaining constraints.
- Deterministic ordering of targets and orders to ensure reproducibility.

## CLI Additions
- `poetry run ts rebalance propose --config <path> --asof YYYY-MM-DD` writes `rebalance_proposal.json` to `reports/<asof>/` and summarizes decisions to stdout.
- `poetry run ts rebalance dry-run --config <path> --asof YYYY-MM-DD --max-candidates 10` evaluates rules without writing artifacts, useful for debugging.

## Verification
1. Use curated data, holdings, and signals fixtures representing a rebalance day; run the CLI to generate a proposal.
2. Inspect JSON output to ensure weights sum to `1 - cash_buffer` and turnover stays within the cap.
3. Run the command on a non-rebalance date and confirm a `NO_REBALANCE` artifact is produced with explanation.
4. Execute unit tests covering ranking tie-breaks, turnover enforcement, and exit handling.

## Dependencies
- S-01, S-03, S-04, S-05 (risk awareness may be used to suppress entries).

## Notes
- Outputs serve as inputs to reporting; keep schema stable and versioned.
