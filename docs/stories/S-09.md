# S-09: CLI Orchestrator

**Last updated:** 2025-09-21

## Outcome
- Provide an operational CLI that exposes each pipeline step and a composed daily run matching the workflow diagram.
- Ensure operators can run `ts` commands with consistent logging, dry-run support, and exit codes.

## Deliverables
- Typer subcommands for each stage: `data pull`, `data preprocess`, `signals build`, `risk evaluate`, `rebalance propose`, `report build`, `notify send`, `backtest run`.
- Composite commands: `ts run daily` (pull → preprocess → risk → report → notify) and `ts run rebalance` (adds signals/rebalance when cadence hit).
- Shared CLI utilities (logging setup, config loading helpers, option groups for `--config`, `--asof`, `--dry-run`).

## Functional Requirements
- Commands share a consistent set of options (e.g., `--config PATH`, `--asof YYYY-MM-DD`, `--force`, `--dry-run`).
- Provide structured logging with timestamps and step identifiers; optionally write logs to `reports/<asof>/run.log`.
- Composite commands must short-circuit on failure and surface the failing step.
- Support environment variable overrides (e.g., `TS_CONFIG_PATH`) for automation contexts.

## CLI Additions
- `poetry run ts run daily --config <path> --asof YYYY-MM-DD` executes the daily workflow and prints a summary manifest.
- `poetry run ts run rebalance --config <path> --asof YYYY-MM-DD --force` executes the full pipeline including signals/rebalance even if off-cadence.
- `poetry run ts steps` lists available subcommands with one-line descriptions and required artifacts.

## Verification
1. Invoke each individual subcommand with fixture inputs to ensure consistent option parsing and logging.
2. Run `poetry run ts run daily --config <config> --asof <date>`; verify that expected artifacts (raw, curated, risk, report, notifications dry-run) are produced in sequence.
3. Simulate a failure (e.g., remove raw data) and confirm composite command stops with non-zero exit and clear message about the failing step.
4. Execute integration tests or a smoke test script that runs the full pipeline end-to-end with sample data.

## Dependencies
- S-02 through S-08.

## Notes
- This story defines the operator UX; subsequent automation (scheduler) should rely exclusively on these commands.
