# S-05: Risk Engine (Daily Defense)

**Last updated:** 2025-09-21

## Outcome
- Evaluate crash and drawdown alerts for current holdings and determine the global market filter state as described in the workflow.
- Emit machine-readable risk alerts feeding the daily report and operator decisions.

## Deliverables
- `trading_system.risk` module implementing `RiskEngine.evaluate` (or equivalent) that ingests curated data, holdings snapshot, and risk config to produce `risk_alerts.json`.
- Support for single-day crash threshold, rolling drawdown threshold, and market filter vs benchmark SMA.
- CLI command `ts risk evaluate --config configs/sample-config.yml --holdings data/holdings.json --asof 2024-05-02` producing risk alerts and console summary.

## Functional Requirements
- Crash alert triggers when daily return <= `crash_threshold_pct`.
- Drawdown alert triggers when drawdown from rolling peak >= `drawdown_threshold_pct` using the configured lookback window.
- Market filter uses curated benchmark data; output includes `market_state` (`RISK_ON`/`RISK_OFF`).
- Output JSON schema: list of per-symbol alert objects with reasons, plus top-level market state and evaluation timestamp.
- Engine must be idempotent and deterministic given identical inputs.

## CLI Additions
- `poetry run ts risk evaluate --config <path> --holdings <holdings.json> --asof YYYY-MM-DD` writes alerts to `reports/<asof>/risk_alerts.json` and prints a summary table.
- `poetry run ts risk explain --symbol AAPL --asof YYYY-MM-DD --config <path>` details the calculations behind each triggered alert.

## Verification
1. Create curated fixture data and a holdings file demonstrating crash and drawdown scenarios.
2. Run the CLI command; confirm alerts file contains expected entries and the console summary matches.
3. Validate JSON against the agreed schema using `jsonschema` or unit tests.
4. Execute unit tests covering edge cases (no holdings, missing benchmark, partial data).

## Dependencies
- S-01, S-03 (curated data), S-02 (benchmark data for market filter).

## Notes
- Keep calculations vectorized for performance; log all thresholds to aid operator review in daily reports.
