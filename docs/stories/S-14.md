# S-14: Holdings Snapshot Toolkit

**Last updated:** 2025-09-21

## Outcome
- Provide utilities to import broker exports (CSV) into the canonical `holdings.json` schema used by risk, rebalance, and reporting.

## Deliverables
- `trading_system.holdings` module with parsers for common broker CSV formats (configurable column mapping).
- Schema validation for holdings (positions array with symbol, quantity, cost basis, as_of_date, optional account metadata).
- CLI command `ts holdings import --csv data/raw/holdings.csv --asof 2024-05-02 --output data/holdings.json`.

## Functional Requirements
- Support mapping columns via CLI or config (e.g., `--map symbol=TICKER --map qty=QUANTITY`).
- Normalize tickers (uppercase), parse numeric values safely, and round costs to two decimals.
- Include cash balance if present; default to zero otherwise.
- Validate resulting JSON against schema and ensure ordering is deterministic (sorted by symbol).
- Provide optional diffing against an existing holdings file to highlight changes before overwriting.

## CLI Additions
- `poetry run ts holdings import --csv <file> --asof YYYY-MM-DD --output data/holdings.json` converts CSV to JSON.
- `poetry run ts holdings validate --file data/holdings.json` checks schema compliance and prints summary statistics.

## Verification
1. Run import command on fixture CSV; inspect resulting JSON and confirm schema adherence.
2. Execute validate command to ensure it reports positions count, total market value (if price provided), and cash balance.
3. Attempt to import CSV with missing columns; confirm descriptive error and non-zero exit.
4. Add unit tests covering parsing, normalization, and validation logic.

## Dependencies
- S-01 (config for paths) and optionally S-05/S-06 which consume holdings.

## Notes
- Clearly document supported broker formats and how to extend mappings in README/CLI help.
