# S-11: Backtest Engine (Deterministic)

**Last updated:** 2025-09-21

## Outcome
- Provide a backtesting harness that reuses live pipeline logic (signals, risk rules, rebalance) to evaluate historical performance with deterministic results.

## Deliverables
- `trading_system.backtest` module orchestrating data loading, signal generation, position tracking, and performance metrics.
- Support for transaction costs (e.g., 0.1% slippage, configurable commissions) and cash management consistent with live workflow.
- CLI command `ts backtest run --config configs/sample-config.yml --start 2018-01-01 --end 2024-05-02 --output reports/backtests/base` producing metrics and charts.

## Functional Requirements
- Reuse existing strategy and rebalance engines to avoid logic drift between backtest and live.
- Output metrics: CAGR, Sharpe, Sortino, max drawdown, volatility, hit rate, turnover, drawdown timelines.
- Produce equity curve CSV and optional interactive Plotly HTML chart.
- Deterministic random seeds; rerunning with same inputs yields identical outputs.
- Support scenario tagging (e.g., `--label momentum_v1`) for organizing results.

## CLI Additions
- `poetry run ts backtest run --config <path> --start YYYY-MM-DD --end YYYY-MM-DD --output <dir>` executes the backtest and writes metrics JSON/CSV, charts, and a summary report.
- `poetry run ts backtest compare --baseline reports/backtests/base --candidate reports/backtests/experiment` prints delta metrics.

## Verification
1. Run a short backtest on fixture curated data and verify output metrics match expected hand calculations.
2. Re-run the same command; confirm outputs (metrics JSON, equity curve) are identical (byte-for-byte or hashed).
3. Execute unit tests covering portfolio accounting, transaction cost application, and deterministic seeding.
4. Validate Plotly/Matplotlib charts load without JavaScript errors (for HTML) or missing labels (for PNG/PDF exports).

## Dependencies
- S-03, S-04, S-06 (core engines), optional S-05 for risk overlays.

## Notes
- Persist backtest manifests so that S-13 can include them in golden regression runs.
